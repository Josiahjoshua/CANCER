{% extends 'main/base.html' %}
{% load static %}

{% block contentTitle %}
{{patient.name}}, {{patient.bed_num}}
{% endblock contentTitle %}

{% block content %}
{% comment %} patient details at registration(profile card) {% endcomment %}
{% comment %} download btn {% endcomment %}
{% comment %} report file upload {% endcomment %}

{% comment %} <div class="row">
	<div class="col-md-3">
		<!--left col-->
		<div class="text-center">
			<img src="http://ssl.gstatic.com/accounts/ui/avatar_2x.png" class="avatar img-circle img-thumbnail"
				alt="avatar" />
			<h6>Upload a different photo...</h6>
			<input type="file" class="text-center center-block file-upload" />
		</div>
	</div>
	{% endcomment %}

	<form class="form" action="" method="post" id="registrationForm">
		{% csrf_token %}
		<div class="container">
			<div class="patient-form">
				<div class="row">
					<div class="col-md-4 form-field mt-4 mb-0">
						<label for="mobile">
							<h6>Patient's contact</h6>
							<input type="text" id="name" class="input-text" type="text" name="mobile"
								placeholder="Mobile No" value="{{patient.phone_num}}">
						</label>
					</div>

					<div class="offset-md-2 col-md-4 form-field mt-4 mb-0">
						<label for="mobile" class="mb-0">
							<h6>Relative's contact</h6>
							<input type="text" id="mobile2" class="input-text" type="text" name="mobile2"
								placeholder="Mobile No" value="{{patient.patient_relative_contact}}">
						</label>
					</div>

					<div class="form-field mt-4">
						<label for="relativeName" class="mb-0">
							<h6>Relative's Name</h6>
							<input type="text" class="input-text" name="relativeName" id="realtiveName"
								value="{{patient.patient_relative_name}}" />
						</label>
					</div>
					<!-- </div>	 -->

					<!-- <div class="row">	 -->
					<div class="col-md-7 form-field mt-0">
						<label for="address" class="mb-0 mt-0">
							<h6>Address</h6>
						</label>
						<input type="address" class="input-text" id="location" placeholder="address" name="location"
							title="enter a location" value="{{patient.address}}" />

					</div>
					<!-- </div> -->

					<div class="offset-md-1 col-md-4 form-field mt-0">
						<label for="symptoms" class="mb-0">
							<h6>Symptoms</h6>
						</label>
						<input type="text" class="input-text" name="symptons" id="symptons"
							value="{{patient.symptoms}}" />
					</div>

					<div class="col-md-7">
						<h6>Prior ailments</h6>
						<label for="prior_ailments">
							<h4>{{patient.prior_ailments}}</h4>
						</label>

					</div>

					<div class="col-md-5">
						<h6>Bed number</h6>
						<label for="bed_num" class="mb-0">
							<h4>{{patient.bed_num}}</h4>
						</label>
					</div>

					<div class="col-md-6">


						{% comment %}
						<label for="symptoms" class="mb-0">
							<h6>Symptoms</h6>
						</label>
						<input type="text" class="input-text" name="symptons" id="symptons"
							value="{{patient.symptoms}}" />
						{% endcomment %}
						<label for="status" class="mb-0">
							<h6>Status</h6>
						</label>
						<input type="text" class="input-text" name="status" id="status" value="{{patient.status}}" />

					</div>

					<div class="col-md-6">
						<label for="doctor" class="mb-0">
							<h6>Doctor Assigned: </h6>
						</label>
						<input type="text" class="input-text" name="doctor" id="doctor" value="{{patient.doctor}}" />
					</div>

					<div class="col-md-6">
						<label for="doctor_time" class="mb-0 mt-4">
							<h6>Doctor Visiting Time: </h6>
						</label>
						<input type="text" class="input-text" name="doctor_time" id="doctor_time"
							value="{{patient.doctors_visiting_time}}" />
					</div>
					<div class="col-md-6">
						<div class="col-md-6 mx-auto">
							<br />
							<button id="uploadBtn" class="btn btn-primary">
								<i class="fa fa-upload"></i> Upload DICOM Image for Analysis
							</button>
						</div>
					</div>

					<div class="col-md-6">
						<label for="doctor_notes" class="mb-0 mt-4">
							<h6>Doctor Notes: </h6>
						</label>
						<!-- <label for="bed_num"> -->
						<textarea class="input-text" name="doctor_notes" id="doctor_notes"
							{{patient.doctors_notes}}>{{patient.doctors_notes}}</textarea>

					</div>

				</div>
			</div>
		</div>

		<div class="form-group">
			<div class="col-md-5 mx-auto">
				<br />
				<button class="btn btn-lg btn-success btn-block mx-auto" type="submit">
					<i class="glyphicon glyphicon-ok-sign"></i> Save
				</button>
			</div>
		</div>

		<!-- The Modal -->
		<!-- <div id="myModal" class="modal">
			<div class="modal-content">
				<span class="close">&times;</span>
				<h2>Prediction Result</h2>
				<p id="prediction-result"></p>
				<a href="{% url 'upload_and_predict' %}">Upload another image</a>
			</div>
		</div> -->

<!-- Upload Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Upload DICOM for Analysis</h2>
		<form id="uploadForm" enctype="multipart/form-data" method="post">
            {% csrf_token %}
			{{ form }}
			<hr>
            <button type="submit" class="btn btn-success">Analyze</button>
        </form>
        <div id="loading" style="display: none;">Analyzing image...</div>
    </div>
</div>

<!-- Results Modal -->
<div id="resultsModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Analysis Results</h2>
        <div id="resultsContent">
            <p><strong>Predicted Class: </strong><span id="predictedClass"></span></p>
            <p><strong>Probability of Cancer: </strong><span id="cancerProbability"></span></p>
            <p><strong>Calcification Type: </strong><span id="calcificationType"></span></p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadModal = document.getElementById('uploadModal');
        const resultsModal = document.getElementById('resultsModal');
        const uploadForm = document.getElementById('uploadForm');
        const loading = document.getElementById('loading');

        uploadBtn.onclick = function(event) {
            event.preventDefault();
            uploadModal.style.display = "block";
        };

        document.querySelectorAll('.close').forEach(function(closeBtn) {
            closeBtn.onclick = function() {
                this.closest('.modal').style.display = "none";
            };
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = "none";
            }
        };

        uploadForm.onsubmit = function(e) {
            e.preventDefault();
            loading.style.display = "block";
            
            fetch("{% url 'upload_and_predict' %}", {
                method: 'POST',
                body: new FormData(this),
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = "none";
                uploadModal.style.display = "none";
                
                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById('predictedClass').textContent = data.predicted_class;
                    document.getElementById('cancerProbability').textContent = (data.cancer_probability * 100).toFixed(2) + '%';
                    document.getElementById('calcificationType').textContent = data.calcification_type;
                    
                    resultsModal.style.display = "block";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                loading.style.display = "none";
                alert('An error occurred during analysis.');
            });
        };
    });
</script>

<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
</style>

{% endblock content %}